# åˆ†åº“åˆ†è¡¨

å¦‚ä½•è®¾è®¡ä¸€ä¸ªä¸šåŠ¡æ— æ„Ÿçš„åˆ†åº“åˆ†è¡¨ç»„ä»¶â“

å¦‚ä¸‹æ˜¯jdbcçš„æ¥å£ï¼Œå®ç°æœ‰Druidã€mybatisç­‰ã€‚

| ç±»/æ¥å£               | ä½œç”¨                 | ä½¿ç”¨åœºæ™¯                  |
| :-------------------- | :------------------- | :------------------------ |
| **DataSource**        | è¿æ¥å·¥å‚ï¼Œç®¡ç†è¿æ¥æ±  | åº”ç”¨å¯åŠ¨æ—¶é…ç½®ï¼Œå…¨å±€ä½¿ç”¨  |
| **Connection**        | æ•°æ®åº“ä¼šè¯           | äº‹åŠ¡ç®¡ç†ï¼Œåˆ›å»º Statement  |
| **Statement**         | æ‰§è¡Œé™æ€SQL          | ç®€å•æŸ¥è¯¢ï¼ˆæœ‰SQLæ³¨å…¥é£é™©ï¼‰ |
| **PreparedStatement** | é¢„ç¼–è¯‘SQL            | å‚æ•°åŒ–æŸ¥è¯¢ï¼ˆå®‰å…¨ï¼Œæ¨èï¼‰  |
| **CallableStatement** | è°ƒç”¨å­˜å‚¨è¿‡ç¨‹         | æ‰§è¡Œå­˜å‚¨è¿‡ç¨‹              |
| **ResultSet**         | ä¿å­˜æŸ¥è¯¢ç»“æœ         | éå†å’Œå¤„ç†æŸ¥è¯¢æ•°æ®        |

æ­£å¸¸çš„æµç¨‹æ˜¯ï¼š

1ï¸âƒ£ä»DataSourceä¸­è·å–Connection

2ï¸âƒ£ä»Connectionè·å–å„ç§ç±»å‹çš„Statementï¼ˆä¼ å…¥sqlï¼‰

3ï¸âƒ£Statementæ‰§è¡Œsql

éœ€è¦åœ¨æ­£å¸¸çš„æµç¨‹ä¸ŠåŒ…è£…ä¸€å±‚åˆ†åº“åˆ†è¡¨çš„æµç¨‹ï¼Œä¹Ÿå°±æ˜¯å®ç°ShardDataSourceï¼ŒShardConnectionï¼ŒShardPreparedStatementç­‰ã€‚

ShardPreparedStatementå»æ‰§è¡ŒğŸ‘‡ğŸ»æµç¨‹ï¼š

è§£æsql â†’ è·å–tableNameå’Œsqlå‚æ•° â†’ å¾—åˆ°tableNameå¯¹åº”çš„åˆ†åº“åˆ†è¡¨è§„åˆ™ï¼Œå°†sqlå‚æ•°æ˜ å°„åˆ°å®é™…çš„è¡¨å’Œåº“å â†’ ç”Ÿæˆåˆ†è¡¨å’Œåˆ†åº“åï¼Œæ”¹å†™sql â†’ åˆ°å¯¹åº”çš„åˆ†åº“ä¸Šå»æ‰§è¡Œsqlã€‚

â“å¦‚ä½•åˆ°å¯¹åº”åˆ†åº“å»æ‰§è¡Œâ“

ğŸ“¢ä¸šåŠ¡ä¸­å¯ä»¥è®°å½•åˆ†åº“ååˆ°åŸå§‹DataSourceï¼ˆåˆ†åº“ï¼‰çš„æ˜ å°„ã€‚

â“å¦‚ä½•å°†sqlå‚æ•°â•åˆ†è¡¨è§„åˆ™æ˜ å°„åˆ°å¯¹åº”çš„åˆ†åº“å’Œåˆ†è¡¨â“

**åˆ†è¡¨**ï¼š

* åˆ†ç‰‡ï¼šåˆ†Nä¸ªç‰‡ï¼Œæ¯”å¦‚ï¼štable_name_001ã€table_name_002ã€table_name_003ã€...ã€table_name_255
* åˆ†åŒºï¼šæŒ‰ç…§æ—¶é—´ï¼ˆå¹´ã€æœˆä»½ã€å¤©ï¼‰åˆ†åŒºï¼Œæ¯”å¦‚ï¼štable_name_2020ã€table_name_2021ã€...ã€table_name_2025
* åˆ†ç‰‡+åˆ†åŒºï¼šåˆ†Nä¸ªç‰‡ï¼Œæ¯ä¸ªç‰‡å†æŒ‰ç…§æ—¶é—´å»åˆ†åŒºï¼Œæ¯”å¦‚ï¼štable_name_001_2020ã€table_name_001_2021ã€table_name_002_2020ã€table_name_002_2021ã€...ã€table_name_255_2020ã€...ã€table_name_255_2021

ä¸‹é¢æ˜¯åˆ†è¡¨è§„åˆ™çš„ä¸€ä¸ªç¤ºä¾‹ï¼š

````json
{
    "table_shard_rule": {
        "table": "table_name",
        "shardCount": 256,
        "shardField": "user_id",
        "partitionField": "create_time",
        "partitionFormat": "yyyy",
        "partitionRetentionCount": 3
    }
}
````

æ‰§è¡Œsqlæµç¨‹â“

åŒ¹é…ruleï¼Œtable_shard_ruleä¼šå¯¹åº”ä¸€ä¸ªåŸå§‹DataSourceï¼ˆå•åº“ï¼‰ï¼Œå°±æ˜¯è¯´åŒ¹é…åˆ°äº†è¿™ä¸ªè§„åˆ™ï¼Œå°±ä¼šå°†sqlåˆ°è¿™ä¸ªåº“ï¼ˆDataSourceï¼‰å»æ‰§è¡Œã€‚

**åˆ†åº“**

åˆ†åº“çš„è§„åˆ™åŒåˆ†è¡¨ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼Œåˆ†åº“åä¸º:db1ã€db_2ã€db3ã€db4

````json
{
    "db_shard_rule": {
        "table": "table_name",
        "shardCount": 4,
        "shardField": "user_id"
    }
}
````

æ‰§è¡Œsqlæµç¨‹â“

åŒ¹é…ruleï¼Œdb_shard_ruleä¼šç”Ÿæˆsqlå¯¹åº”çš„åˆ†åº“åï¼Œtable_shard_ruleä¼šå¯¹åº”ä¸€ä¸ªåŸå§‹DataSource mapï¼Œkeyæ˜¯åˆ†åº“åï¼Œvalueæ˜¯åŸå§‹DataSourceã€‚æœ€ç»ˆsqlä¼šæ ¹æ®åˆ†åº“åæ‰¾åˆ°å¯¹åº”çš„DataSourceï¼Œç„¶åå»æ‰§è¡Œsqlã€‚

